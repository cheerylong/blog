<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="前端"><title>【译】React Native布局原理（以及Fabric将做出的改变） | cheerylong'blog</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【译】React Native布局原理（以及Fabric将做出的改变）</h1><a id="logo" href="/blog/.">cheerylong'blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【译】React Native布局原理（以及Fabric将做出的改变）</h1><div class="post-meta">Jan 24, 2019<span> | </span><span class="category"><a href="/blog/categories/React-Native/">React Native</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/blog/2019/01/24/Native如何构建布局（以及Fabric将做出的改变）/#vcomment"><span class="valine-comment-count" data-xid="/blog/2019/01/24/Native如何构建布局（以及Fabric将做出的改变）/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#目前React-Native是如何工作的"><span class="toc-number">1.</span> <span class="toc-text">目前React Native是如何工作的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内部通信"><span class="toc-number">2.</span> <span class="toc-text">内部通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存在的问题"><span class="toc-number">3.</span> <span class="toc-text">存在的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍Fabric"><span class="toc-number">4.</span> <span class="toc-text">介绍Fabric</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将Native-API直接暴露给JavaScript"><span class="toc-number">5.</span> <span class="toc-text">将Native API直接暴露给JavaScript</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小贴士"><span class="toc-number">6.</span> <span class="toc-text">小贴士</span></a></li></ol></div></div><div class="post-content"><p><img src="https://user-gold-cdn.xitu.io/2019/1/20/1686b38c126680b5?w=1920&amp;h=1080&amp;f=jpeg&amp;s=440457" alt=""></p>
<blockquote>
<ul>
<li>原文作者：<a href="https://medium.freecodecamp.org/@mehulmpt" target="_blank" rel="noopener">Mehul Mohan
</a></li>
<li>原文链接: <a href="https://medium.freecodecamp.org/how-react-native-constructs-app-layouts-and-how-fabric-is-about-to-change-it-dd4cb510d055" target="_blank" rel="noopener">How React Native constructs app layouts (and how Fabric is about to change it)</a></li>
<li>作者 React Native 入门教程：<a href="https://www.udemy.com/react-native-first-steps/?couponCode=MEDIUM_SPECIAL" target="_blank" rel="noopener">React Native - First Steps
</a></li>
<li>作者 Twitter: <a href="https://twitter.com/mehulmpt" target="_blank" rel="noopener">Mehul Mohan</a></li>
</ul>
</blockquote>
<p><code>React Native</code> 团队一直致力研究一些可以从根本上改变 <code>React Native</code>内部与操作系统协同工作的方式。<br>在官方没发布前，暂且称这个项目为 “Project Fabric”</p>
<p>让我们来讨论下它是什么以及它会为开发人员带来什么变化。</p>
<h2 id="目前React-Native是如何工作的"><a href="#目前React-Native是如何工作的" class="headerlink" title="目前React Native是如何工作的"></a>目前React Native是如何工作的</h2><p><code>React Native</code> 目前使用3个线程：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/20/1686b44a5766b0ce?w=965&amp;h=507&amp;f=jpeg&amp;s=40227" alt=""></p>
<ol>
<li><p>UI线程 - 这是运行 <code>Android / iOS</code> 应用程序的主要应用程序线程。<br>它可以访问UI，UI也只能由此线程更改。</p>
</li>
<li><p>影子线程 - 此线程是 <code>React Native</code> 用于计算 <code>React</code> 创建的布局的后台线程。</p>
</li>
<li><p>JavaScript线程 - 此线程是 <code>JavaScript</code> 代码（实际上是您的 <code>React</code> 代码）的执行环境。</p>
</li>
</ol>
<h2 id="内部通信"><a href="#内部通信" class="headerlink" title="内部通信"></a>内部通信</h2><p>让我们从头开始分析构建过程，假设你要在屏幕中央绘制一个红色框。<br>那么，你的JS线程包含用于创建这个布局的代码。<br>这是一段典型的 React Native（RN） 布局代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;View style=&#123;&#123; <span class="attr">flex</span>: <span class="number">1</span>, <span class="attr">justifyContent</span>: <span class="string">"center"</span>, <span class="attr">alignItems</span>: <span class="string">"center"</span> &#125;&#125;&gt;</span><br><span class="line">    &lt;View style=&#123;&#123;<span class="attr">width</span>: <span class="number">100</span>, <span class="attr">height</span>: <span class="number">100</span>, <span class="attr">backgroundColor</span>: <span class="string">"red"</span>&#125;&#125;&gt;&lt;/View&gt;</span><br><span class="line">&lt;<span class="regexp">/View&gt;</span></span><br></pre></td></tr></table></figure>
<p>系统有自己的布局实现方式，它并不理解你刚刚编写的Flexbox代码。因此，<code>RN</code> 首先必须将您的 <code>flexbox</code> 编码布局转换为系统可以理解的布局系统。</p>
<p>继续来看，在转换之前，我们需要将此布局计算部分转交到另一个线程，以便我们可以保持 <code>JavaScript</code> 线程继续执行。因此，RN使用了影子线程，它本质上是在构建了JS线程中编码的布局树。在这个线程中，RN 使用了一个名为 <a href="https://github.com/facebook/yoga" target="_blank" rel="noopener">Yoga</a> 的布局引擎，它将基于 <code>flexbox</code> 的布局转换为系统可以理解的布局。</p>
<p><code>React Native</code> 使用 <code>React Native bridge</code> 将这些信息从JS线程传递给Shadow线程。<br>简而言之，这只是以JSON格式序列化数据并将其作为字符串传输到 <code>React Native bridge</code> 上。</p>
<p>这时，我们正处于Shadow线程中。JS线程正在执行，屏幕上没有任何内容。<br>一旦我们从 <code>yoga</code> 获得了渲染标记，这些信息将再次通过 <code>React Native bridge</code> 传输到UI线程。<br>同样，这会在Shadow线程上执行一些序列化并在主线程上执行反序列化。然后主线程会渲染出 UI。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/20/1686b4bcdd6c93a7?w=922&amp;h=475&amp;f=jpeg&amp;s=43424" alt=""></p>
<h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h2><p>你可以看到，线程之间的所有通信都发生在 <code>bridge</code> 上，但是同时存在很多限制。<br>包括：</p>
<ul>
<li>传输较大数据（比如将图像转换为base64字符串信息）会很慢，<br>如果只需指向内存中的数据就可以实现相同的任务，这些就是不必要的数据拷贝</li>
</ul>
<p>另外，所有的通信都是异步的，在大多数情况下这是没问题的。<br>但是，目前没有办法同步从JS线程更新UI线程。当您使用具有大量数据的 <code>FlatList</code> 时，这就会产生问题。（你可以将 <code>FlatList</code> 视为 <code>RecyclerView</code> 的较差实现。）<br>最后，由于JS线程和UI线程之间通信是这种异步的方式，严格要求同步数据访问的原生模块并不能完全使用。<br>例如，<code>android</code> 上的 <code>RecyclerView</code> 为了屏幕上没有闪烁，适配器需要同步访问它所呈现的数据。<br>由于目前 <code>React Native</code> 的多线程架构，无法做到这一点。</p>
<h2 id="介绍Fabric"><a href="#介绍Fabric" class="headerlink" title="介绍Fabric"></a>介绍Fabric</h2><p>我们回头来看看浏览器的布局。我们仔细想下，浏览器渲染出的输入框，按钮等实际上是依赖于操作系统的。因此，在渲染时，你的浏览器会询问您的操作系统（Windows，Mac，Linux或其他的系统），例如，应该在网页上的哪个位置绘制输入框？那让我们来看下浏览器和<code>React Native</code> 的线程映射关系。</p>
<ul>
<li><p>UI线程 → UI线程</p>
</li>
<li><p>浏览器渲染引擎 → React Native渲染引擎（Yoga / Shadow thread）</p>
</li>
<li><p>JavaScript线程 → JavaScript线程</p>
</li>
</ul>
<p>我们知道现代浏览器非常成熟，可以有效地处理掉所有这些任务。<br>那为什么 <code>React Native</code>不能这么做呢？是什么限制了它不能像浏览器这样来工作呢？</p>
<h2 id="将Native-API直接暴露给JavaScript"><a href="#将Native-API直接暴露给JavaScript" class="headerlink" title="将Native API直接暴露给JavaScript"></a>将Native API直接暴露给JavaScript</h2><p><img src="https://user-gold-cdn.xitu.io/2019/1/20/1686b4ec682c467f?w=547&amp;h=269&amp;f=jpeg&amp;s=32764" alt=""></p>
<p>你曾经有没有在控制台中写过像 <code>document.getElementById</code> 这样的命令以及 <code>setTimeout</code> 和 <code>setInterval</code> 之类的代码并看到打印出的结果？他们的实现结果是 <code>[native code]</code> , 这是什么意思呢？可以发现，当你执行这些方法时，它们不会调用任何 <code>JavaScript</code> 代码。反而，这些方法会直接调用到本机的C ++代码。所以其实浏览器不允许JS使用桥接与主机操作系统进行通信，而是使用本机代码直接向系统暴露JS接口！简而言之，这就是 <code>React Native Fabric</code> 将要做的事情：消除桥接通信并且使用本机代码直接通过JS线程控制UI。</p>
<h2 id="小贴士"><a href="#小贴士" class="headerlink" title="小贴士"></a>小贴士</h2><ul>
<li>RN Fabric允许UI线程（绘制UI的位置）与JS线程（UI编程的位置）同步</li>
<li>Fabric仍处于开发阶段，React Native团队确实没有提到截至目前的公开发布日期。<br>但我很确定今年我们会看到一些很棒的东西。</li>
<li>像这样的应用程序开发框架（RN，NativeScript，Flutter）将会发展的越来越好！</li>
</ul>
<p><em>图片来源：https：//<a href="http://www.slideshare.net/axemclion/react-native-fabric-review20180725" target="_blank" rel="noopener">www.slideshare.net/axemclion/react-native-fabric-review20180725</a></em></p>
</div><div class="tags"><a href="/blog/tags/React-Native/">React Native</a></div><div class="post-nav"><a class="pre" href="/blog/2019/06/02/axios源码浅析/">axios源码浅析</a><a class="next" href="/blog/2018/11/20/puppeteer截取直播间画面/">Puppeteer截取直播画面</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'jHUxpH4l71M0cttbwppTQmHw-gzGzoHsz',
  appKey:'nTJUGg5SKK6Q5QbQKjgLbDr3',
  placeholder:'尽情吐槽吧...em... 我后悔了,大侠嘴下留情',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://cheerylong.github.io/blog"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/JavaScript/">JavaScript</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/React-Native/">React Native</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/小程序/">小程序</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/工具/">工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/感悟/">感悟</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/数据结构和算法/">数据结构和算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/生活/">生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/零散知识拾遗/">零散知识拾遗</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/JavaScript数据结构/" style="font-size: 15px;">JavaScript数据结构</a> <a href="/blog/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/blog/tags/React-Native/" style="font-size: 15px;">React Native</a> <a href="/blog/tags/工具/" style="font-size: 15px;">工具</a> <a href="/blog/tags/感悟/" style="font-size: 15px;">感悟</a> <a href="/blog/tags/其它/" style="font-size: 15px;">其它</a> <a href="/blog/tags/小程序/" style="font-size: 15px;">小程序</a> <a href="/blog/tags/生活/" style="font-size: 15px;">生活</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2019/06/02/axios源码浅析/">axios源码浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/01/24/Native如何构建布局（以及Fabric将做出的改变）/">【译】React Native布局原理（以及Fabric将做出的改变）</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/11/20/puppeteer截取直播间画面/">Puppeteer截取直播画面</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/11/小程序之工程化/">小程序之工程化</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/11/小程序之图片导出/">小程序之图片导出</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/06/小程序之数据统计/">小程序之数据统计</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/08/05/小程序之登录/">小程序之登录</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/04/17/最近糟心的一点事/">最近糟心的一点事</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/04/07/图片格式比较/">图片格式比较</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2018/03/29/JavaScript实现sleep/">js实现sleep</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/cheerylong" title="Github" target="_blank">Github</a><ul></ul><a href="https://www.zhihu.com/people/jie-wei-17-90/activities" title="知乎" target="_blank">知乎</a><ul></ul><a href="https://juejin.im/user/57c6aaa8c4c9710061a7fbe4" title="掘金" target="_blank">掘金</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/blog/." rel="nofollow">cheerylong'blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = '//hm.baidu.com/hm.js?' + 'fbd56cca57242535d5a2abe135b52021';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=0.0.0"></script></div></body></html>